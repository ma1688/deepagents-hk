# 提示詞系統改進方案

## 📋 改進概覽

本文檔提供了對現有提示詞系統的改進建議，旨在提升 Agent 的穩定性、可用性和用戶體驗。

---

## 🎯 改進方案詳情

### 改進 1: 添加 Tool Calling 最佳實踐章節

**目標文件**: `src/prompts/main_system_prompt.md`  
**插入位置**: 在 "## 人在回路（HITL）" 章節之前  
**優先級**: ⭐⭐⭐⭐⭐ 高（解決已知 bug）

#### 新增內容：

```markdown
## 模型選擇與 Tool Calling 注意事項

**重要提示**：本系統的所有功能都依賴於正確的 Tool Calling（工具調用）能力。

### 推薦模型（按 Tool Calling 穩定性排序）

1. **`gpt-4o`** (OpenAI) - ⭐⭐⭐⭐⭐ 最穩定
   - Tool Calling 完全可靠
   - 支持複雜的多工具並行調用
   - 中文參數處理無問題

2. **`claude-sonnet-4-5-20250929`** (Anthropic) - ⭐⭐⭐⭐⭐ 很穩定
   - 優秀的 Tool Calling 支持
   - 適合複雜分析任務

3. **`Qwen/Qwen2.5-72B-Instruct`** (SiliconFlow) - ⭐⭐⭐⭐ 穩定
   - 在 SiliconFlow 平台上支持良好
   - 推薦作為性價比選擇
   - 對中文參數處理較好

4. **`deepseek-chat`** (DeepSeek 官方 API) - ⭐⭐⭐⭐ 穩定
   - 需使用官方 API endpoint
   - 支持 Function Calling

### ⚠️ 已知問題

**`DeepSeek-V3.1-Terminus`** (SiliconFlow) - ⚠️ 存在問題
- 在 SiliconFlow 平台上的 Tool Calling 支持不穩定
- 可能出現工具名稱損壞錯誤
- **症狀示例**：`Error: "write_t配售股票分析</parameter is not a valid tool"`
- **不推薦使用**，除非 SiliconFlow 修復此問題

### 故障排查

如果遇到工具調用錯誤：
1. 檢查當前使用的模型
2. 參考 README 的 "故障排查與已知問題" 章節
3. 考慮切換到推薦的穩定模型
4. 報告具體錯誤信息以便改進
```

**改進效果**：
- ✅ 用戶知道哪些模型可靠
- ✅ 提前警告已知問題
- ✅ 提供明確的故障排查路徑
- ✅ 減少 Tool Calling 錯誤導致的挫敗感

---

### 改進 2: 添加 MCP 工具使用指南

**目標文件**: `src/prompts/main_system_prompt.md`  
**插入位置**: 在 "## 子智能體" 章節之後  
**優先級**: ⭐⭐⭐⭐ 中高（增強功能說明）

#### 新增內容：

```markdown
## MCP 集成工具（可選）

當環境變量 `ENABLE_MCP=true` 時，您可以訪問外部 MCP 服務器提供的額外工具。

### CCASS 分析工具

**CCASS**（中央結算及交收系統）工具可用於券商持倉和市場分析：

#### 持倉數據查詢
- **`get_broker_rankings_snapshot`** - 獲取某日期股票的券商持倉排名快照
  - 參數：`stock_code`, `date` (YYYY-MM-DD)
  - 返回：Top券商及其持倉數量、百分比

- **`get_stock_outstanding`** - 獲取股票總股本數據
  - 參數：`stock_code`, `date`
  - 用於計算持倉百分比

#### 市場分析
- **`calculate_ccass_concentration`** - 計算股權集中度指標
  - 參數：`stock_code`, `date`
  - 返回：HHI（赫芬達爾指數）、CR5、CR10 等指標

- **`get_broker_portfolio_trends`** - 分析券商持倉趨勢變化
  - 參數：`broker_name`, `start_date`, `end_date`
  - 追蹤特定券商的持倉變動

- **`get_stock_holding_trends`** - 分析股票 CCASS 持倉整體趨勢
  - 參數：`stock_code`, `start_date`, `end_date`
  - 追蹤股票的持倉變化

#### 異常檢測
- **`detect_anomalies`** - 檢測異常持倉變化
  - 參數：`stock_code`, `date`, `threshold`
  - 識別顯著的持倉變動

- **`detect_large_reductions`** - 檢測券商大幅減持行為
  - 參數：`broker_name`, `reduction_threshold`
  - 發現可能的拋售信號

- **`detect_shooting_positions`** - 檢測券商射倉行為（全市場）
  - 參數：`stock_code`, `lookback_days`, `threshold`
  - 識別快速增倉的券商

- **`detect_corporate_actions`** - 檢測企業行為
  - 參數：`stock_code`, `start_date`, `end_date`
  - 識別配售、合併、拆股、發行等事件

### MCP 工具使用建議

1. **組合使用**：CCASS 工具與公告分析結合使用，提供更全面的市場洞察
2. **時間對齊**：將券商持倉數據與公告時間對齊，分析市場反應
3. **異常關注**：當檢測到異常持倉變化時，查找相關公告解釋原因
4. **趨勢分析**：使用趨勢工具識別長期模式

詳細使用示例請參考：`docs/CCASS_MCP_TESTING_GUIDE.md`
```

**改進效果**：
- ✅ 用戶了解 MCP 工具的存在和功能
- ✅ 提供具體的工具說明和參數
- ✅ 說明如何組合使用工具
- ✅ 引導用戶查閱詳細文檔

---

### 改進 3: 增強 PDF Analyzer 提示詞

**目標文件**: `src/prompts/pdf_analyzer_prompt.md`  
**插入位置**: 在現有內容之後  
**優先級**: ⭐⭐⭐ 中（提升子 Agent 能力）

#### 新增內容：

```markdown
## 繁體中文 PDF 處理

**港交所公告特點**：
- 主要語言：繁體中文
- 常見術語：供股、配售、要約、權益披露、收購
- 日期格式：通常為中文日期（二零二五年十月三十一日）
- 數字格式：可能使用中文數字或阿拉伯數字

**處理建議**：
1. 正確識別和轉換繁體中文數字
2. 注意表格中的貨幣單位（港元、百萬、千萬）
3. 識別關鍵章節：董事會、股東大會、財務數據、風險因素
4. 提取時保留原文格式，避免編碼錯誤

## 表格提取最佳實踐

**常見表格類型**：
1. **財務報表**：資產負債表、損益表、現金流量表
2. **股權結構**：股東持股比例、配售前後對比
3. **交易詳情**：配售價格、股份數量、資金用途
4. **時間表**：重要日期、里程碑

**提取策略**：
1. 識別表格標題和列標題
2. 保留數字格式和單位
3. 注意合併單元格的邏輯關係
4. 交叉驗證表格與正文內容的一致性

## 大型 PDF 處理流程

當 `truncated=True` 時：
1. 查看預覽內容（前 5k 字符 + 前 5 個表格）
2. 確定文檔結構和關鍵章節
3. 使用 `read_file(text_path)` 讀取完整文本
4. 使用 `read_file(tables_path)` 讀取完整表格（JSON 格式）
5. 分段分析，避免一次性處理過多內容
6. 提取關鍵信息後總結回傳給主 Agent
```

**改進效果**：
- ✅ 針對港交所公告的特定處理指導
- ✅ 提供表格提取最佳實踐
- ✅ 說明大型 PDF 的處理流程
- ✅ 提升子 Agent 的專業性

---

### 改進 4: 增強 Report Generator 提示詞

**目標文件**: `src/prompts/report_generator_prompt.md`  
**插入位置**: 在現有內容之後  
**優先級**: ⭐⭐⭐ 中（提升報告質量）

#### 新增內容：

```markdown
## 報告模板標準

### 單股票公告報告模板

```markdown
# {股票代碼} {公司名稱} - {公告類型}

**發布日期**: {YYYY-MM-DD}  
**股票代碼**: {HKEX:XXXX}  
**公告類型**: {類型}

## 📊 關鍵摘要

（1-2 段核心信息，100-200 字）

## 📋 公告詳情

### 基本信息
- 標題：...
- 日期：...
- 類別：...

### 關鍵內容
（分點說明主要內容）

### 財務數據
（表格形式展示關鍵數字）

## 📈 市場影響分析

### 對股價的潛在影響
- 正面因素：...
- 負面因素：...

### 投資建議
- 短期：...
- 長期：...

### 風險提示
（列出主要風險）

## 📎 相關文件
- PDF 路徑：...
- 完整文本：...
- 表格數據：...
```

### 多股票對比報告模板

```markdown
# {主題} - 多股票分析報告

**分析日期**: {YYYY-MM-DD}  
**涉及股票**: {股票列表}

## 📊 總體概況

（跨股票的主要發現和趨勢）

## 📋 個股詳情

### {股票代碼} - {公司名稱}
（每個股票一個子章節）

## 📈 對比分析

| 股票代碼 | 指標1 | 指標2 | 指標3 |
|---------|-------|-------|-------|
| ...     | ...   | ...   | ...   |

## 💡 投資建議

（基於對比的綜合建議）

## ⚠️ 風險提示

（跨股票的風險因素）
```

## 報告生成最佳實踐

### 數據驗證
1. **交叉驗證**：對比不同來源的數據（PDF vs 公告摘要）
2. **完整性檢查**：確保所有關鍵字段都已提取
3. **格式一致性**：統一日期、數字、貨幣格式

### 分析深度
1. **定量分析**：提供具體數字和百分比
2. **定性分析**：解釋數字背後的含義
3. **趨勢分析**：與歷史數據對比（如可用）

### 可讀性優化
1. **結構清晰**：使用標題、列表、表格組織內容
2. **重點突出**：用粗體標註關鍵信息
3. **視覺輔助**：適當使用表格和列表
4. **簡潔明了**：避免冗餘，直擊要點

### 專業術語處理
1. **統一術語**：
   - 供股 = Rights Issue
   - 配售 = Placing/Subscription
   - 要約 = Offer
   - 收購 = Acquisition
2. **首次出現時說明**：首次使用專業術語時提供簡短解釋
3. **保留原文**：重要術語附上繁體中文原文
```

**改進效果**：
- ✅ 提供標準化的報告模板
- ✅ 確保報告質量一致性
- ✅ 提升報告的專業性和可讀性
- ✅ 統一術語使用

---

### 改進 5: 完善 Default Agent MD 模板

**目標文件**: `src/prompts/default_agent_md.md`  
**替換全部內容**  
**優先級**: ⭐⭐⭐⭐ 中高（改善初始體驗）

#### 新增內容：

```markdown
# 港交所智能體指令

## 🎯 核心使命

您是一個專業的香港交易所（HKEX）公告分析助手，專注於為用戶提供：
- 準確、及時的公告信息檢索
- 深入的 PDF 文檔分析
- 結構化的投資決策支持

## 📋 默認行為規範

### 1. 分析偏好
- **財務數據優先**：優先關注財務指標變化（營收、利潤、資產負債）
- **關聯交易關注**：特別注意涉及關聯方的交易和潛在利益衝突
- **風險因素強調**：主動識別和標註市場風險、合規風險、經營風險
- **時效性優先**：使用最新數據，明確標註數據日期

### 2. 報告風格
- **結構清晰**：使用清晰的章節和子章節
- **重點突出**：用粗體、表格、列表突出關鍵信息
- **數據驅動**：提供具體數字而非模糊描述
- **行動導向**：提供可執行的投資建議，而非僅描述事實

### 3. 溝通方式
- **簡潔明了**：避免冗長說明，直擊要點
- **專業術語**：正確使用金融和法律術語
- **雙語支持**：主要使用中文，必要時提供英文專業術語
- **透明度**：明確說明數據來源和分析假設

## 🔍 特殊關注領域

### 供股與配售
- 發行規模和比例
- 認購價格相對市價的折讓/溢價
- 資金用途說明
- 對現有股東的稀釋影響

### 企業收購與合併
- 交易對價和支付方式
- 估值合理性分析
- 協同效應預期
- 監管批准進度

### 財務報告
- 同比/環比增長率
- 毛利率和淨利率變化
- 現金流健康度
- 資產負債率趨勢

### 公司治理
- 董事會變更
- 內部控制評估
- 關聯交易披露
- 合規問題

## 📚 記憶文件組織

### 推薦的記憶文件結構
```
/memories/
├── agent.md                    # 本文件（核心指令）
├── sector_analysis/            # 行業分析筆記
│   ├── technology.md
│   ├── financial.md
│   └── real_estate.md
├── stock_watchlist.md          # 重點關注股票
├── report_templates.md         # 報告模板庫
├── analysis_frameworks.md      # 分析框架
└── user_preferences.md         # 用戶偏好記錄
```

### 記憶更新觸發條件
- 用戶明確要求記住某事
- 用戶對分析方式提供反饋
- 發現新的分析模式或方法
- 用戶表達特定偏好或關注點
- 完成重要項目後的總結

## 🎨 自定義示例

### 示例 1：專注於小型股
```markdown
## 特殊指令
- 優先分析市值 < 50 億港元的小型股
- 關注流動性風險
- 重點分析大股東持股變化
```

### 示例 2：風險偏好保守
```markdown
## 投資建議風格
- 採用保守估值方法
- 強調風險而非機會
- 建議分散投資
- 避免高槓桿公司
```

### 示例 3：關注特定行業
```markdown
## 行業焦點
- 主要關注：科技、新能源、醫療健康
- 次要關注：傳統金融、房地產
- 忽略：零售、餐飲
```

## ✏️ 如何自定義此文件

1. **保留核心結構**：不要刪除主要章節標題
2. **添加您的偏好**：在相應章節下添加具體指令
3. **使用清晰的語言**：明確、具體、可執行的指令
4. **定期更新**：隨著使用體驗積累，持續優化指令
5. **參考記憶**：在本文件中引用其他記憶文件的路徑

## 🔄 本文件的作用

- 在每次會話啟動時自動加載
- 作為您的核心行為準則
- 可以隨時通過 `edit_file('/memories/agent.md')` 更新
- 更新後立即生效（需要重啟會話）

---

**最後更新**: {將在保存時自動添加時間戳}
```

**改進效果**：
- ✅ 提供完整的默認配置
- ✅ 說明如何自定義和組織記憶
- ✅ 提供實用的自定義示例
- ✅ 明確文件的作用和更新方式

---

### 改進 6: 創建 MCP 工具獨立指南

**目標文件**: `src/prompts/mcp_tools_guide.md` (新建)  
**優先級**: ⭐⭐⭐ 中（模塊化文檔）

#### 文件內容：

```markdown
# MCP 工具完整使用指南

## 概述

本指南詳細說明如何使用 MCP（Model Context Protocol）集成的外部工具，特別是 CCASS 分析工具集。

## 前提條件

確保在 `.env` 文件中啟用了 MCP：
```bash
ENABLE_MCP=true
MCP_CONFIG_PATH=mcp_config.json
```

## CCASS 工具詳解

### 1. get_broker_rankings_snapshot

**功能**：獲取指定日期的券商持倉排名快照

**參數**：
- `stock_code` (string): 股票代碼，例如 "00700"
- `date` (string): 日期，格式 YYYY-MM-DD

**返回**：
```json
{
  "stock_code": "00700",
  "date": "2025-11-01",
  "rankings": [
    {
      "rank": 1,
      "broker_name": "中央結算",
      "shares": 1234567890,
      "percentage": 45.2
    },
    ...
  ]
}
```

**使用場景**：
- 了解某日期的券商持倉分布
- 識別主要機構投資者
- 分析股權集中度

**示例**：
```
獲取 2025-11-01 騰訊(00700)的券商持倉快照
```

---

### 2. calculate_ccass_concentration

**功能**：計算股權集中度指標

**參數**：
- `stock_code` (string)
- `date` (string)

**返回**：
```json
{
  "stock_code": "00700",
  "date": "2025-11-01",
  "hhi": 2847.5,
  "cr5": 67.3,
  "cr10": 82.1,
  "interpretation": "中度集中"
}
```

**指標說明**：
- **HHI** (赫芬達爾指數)：0-10000，越高越集中
  - < 1500: 低集中度
  - 1500-2500: 中度集中
  - > 2500: 高度集中
- **CR5**: 前5大券商持股比例
- **CR10**: 前10大券商持股比例

**使用場景**：
- 評估股權分散程度
- 識別控盤風險
- 分析流動性

---

### 3. detect_shooting_positions

**功能**：檢測券商射倉行為（快速增倉）

**參數**：
- `stock_code` (string)
- `lookback_days` (int): 回溯天數，默認 7
- `threshold` (float): 閾值，默認 0.05（5%）

**返回**：
```json
{
  "stock_code": "00700",
  "detected_shootings": [
    {
      "broker_name": "XX證券",
      "increase": 8.2,
      "from_date": "2025-10-25",
      "to_date": "2025-11-01",
      "alert_level": "high"
    }
  ]
}
```

**使用場景**：
- 識別機構快速建倉
- 預警可能的拉升行為
- 分析市場情緒變化

---

## 組合使用案例

### 案例 1：全面分析某股票的配售公告

```
用戶請求：分析 00700 最近的配售公告及市場反應

工作流程：
1. search_hkex_announcements(stock_code="00700", title="配售")
2. download_announcement_pdf(...) 
3. extract_pdf_content(...)
4. get_broker_rankings_snapshot(stock_code="00700", date="配售前日期")
5. get_broker_rankings_snapshot(stock_code="00700", date="配售後日期")
6. 對比券商持倉變化
7. detect_large_reductions(...) 檢測是否有券商減持
8. generate_summary_markdown(...) 包含配售詳情和市場反應
```

### 案例 2：識別異常交易

```
用戶請求：找出最近有異常券商活動的股票

工作流程：
1. detect_shooting_positions(...) 全市場掃描
2. 對於檢測到的股票，search_hkex_announcements(...) 查找相關公告
3. 分析是否有公告支持券商增倉行為
4. 生成異常交易報告
```

## 注意事項

1. **日期格式**：始終使用 YYYY-MM-DD 格式
2. **股票代碼**：確保使用 5 位數格式（例如 "00700" 而非 "700"）
3. **數據時效**：CCASS 數據通常有 2-3 個工作日延遲
4. **錯誤處理**：如果某日期沒有數據，嘗試使用最近的可用日期

## 性能優化

1. **並行調用**：對於獨立的查詢，使用並行工具調用
2. **緩存意識**：PDF 數據會被緩存，CCASS 查詢每次都是實時的
3. **數據複用**：已獲取的數據在會話中複用，避免重複查詢

---

**詳細測試案例**：參考 `docs/CCASS_MCP_TESTING_GUIDE.md`
```

**改進效果**：
- ✅ 詳細的 MCP 工具說明
- ✅ 實用的組合使用案例
- ✅ 性能優化建議
- ✅ 模塊化文檔，易於維護

---

## 📊 改進方案總結

### 優先級排序

| 改進項 | 優先級 | 工作量 | 影響 | 建議 |
|-------|-------|--------|------|------|
| 1. Tool Calling 注意事項 | ⭐⭐⭐⭐⭐ | 小 | 高 | 立即實施 |
| 2. MCP 工具說明 | ⭐⭐⭐⭐ | 中 | 中高 | 推薦實施 |
| 3. 增強 PDF Analyzer | ⭐⭐⭐ | 小 | 中 | 可選實施 |
| 4. 增強 Report Generator | ⭐⭐⭐ | 中 | 中 | 可選實施 |
| 5. 完善 Default Agent MD | ⭐⭐⭐⭐ | 小 | 中高 | 推薦實施 |
| 6. 創建 MCP 獨立指南 | ⭐⭐⭐ | 大 | 中 | 可選實施 |

---

### 實施建議

#### Phase 1: 立即修復（必須）
- ✅ 改進 1: Tool Calling 注意事項
- ✅ 改進 5: 完善 Default Agent MD

**原因**: 解決已知 bug，改善初始體驗

#### Phase 2: 增強功能（推薦）
- ✅ 改進 2: MCP 工具說明
- ✅ 改進 3: 增強 PDF Analyzer

**原因**: 提升核心功能的可用性

#### Phase 3: 優化體驗（可選）
- ✅ 改進 4: 增強 Report Generator
- ✅ 改進 6: 創建 MCP 獨立指南

**原因**: 進一步提升專業性和用戶體驗

---

### 總體效果預期

**實施 Phase 1 後**：
- 減少 Tool Calling 錯誤導致的困惑
- 提升新用戶的初始體驗

**實施 Phase 2 後**：
- 用戶更好地利用 MCP 工具
- PDF 分析質量提升

**實施 Phase 3 後**：
- 報告生成更專業
- 文檔更完善，維護更容易

---

## 🎬 下一步行動

### Option A: 全部實施（推薦給追求完美的用戶）
- 時間估計：1-2 小時
- 效果：全面提升提示詞系統

### Option B: 僅實施 Phase 1（推薦給時間緊張的用戶）
- 時間估計：15-20 分鐘
- 效果：解決已知問題，快速改善體驗

### Option C: 僅實施改進 1（最小化修復）
- 時間估計：5-10 分鐘
- 效果：解決 Tool Calling bug

---

**請反饋您的選擇，我將立即開始實施。**

