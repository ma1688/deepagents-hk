# 🔍 搜索与分析工作流程

## Phase 1: 日期计算

### 规则
- **必须**先获取当前系统日期
- 默认搜索范围: **过去12个月**

### 计算方法

```python
# 系统日期获取（由Agent执行 date +%Y%m%d）
today = "20251204"  # 示例

# 日期参数
to_date = today  # 20251204
from_date = f"{int(today[:4])-1}{today[4:]}"  # 20241204
```

### 日期计算示例

| 当前日期 | from_date | to_date |
|----------|-----------|---------|
| 20251204 | 20241204 | 20251204 |
| 20250315 | 20240315 | 20250315 |
| 20250101 | 20240101 | 20250101 |

---

## Phase 2: 执行搜索

### ⛔ 关键约束

```
禁止: 搜索时使用关键词参数
允许: 仅使用 stock_code + date_range
```

### 调用格式

```python
search_hkex_announcements(
    stock_code="00479",
    from_date="20241204",
    to_date="20251204"
)
```

### 排序规则

- 结果**必须按日期倒序**（最新在前）
- 分析从**最新公告开始**向前追溯

---

## Phase 3: 关键词筛选

> 搜索返回全部公告后，根据用户指定的事件类型**手动筛选**

### 筛选流程

```
[1] 获取搜索结果列表
     ↓
[2] 根据事件类型确定筛选关键词
     │
     ├─ 供股 → 供股|供股權|認購權|按比例
     ├─ 配售 → 配售|授權|配售協議
     └─ 全购 → 要約|全購|強制性
     ↓
[3] 从公告标题中匹配关键词
     ↓
[4] 下载匹配的公告进行详细分析
```

### 排除规则

自动排除以下类型的公告：
- `證券變動月報表` — 例行披露
- `翌日披露報表` — 期权披露
- `月報表` — 例行报告

---

## Phase 4: 事件识别

### 识别顺序

1. **从最新公告开始**浏览
2. **定位结果公告**或最新进展 → 确认事件状态
3. **向前追溯**找到首次建议公告
4. **整理成正序**时间线

### 状态判断

| 最新公告类型 | 事件状态 |
|-------------|---------|
| 《供股结果》《配售完成》 | ✅ 已完成 |
| 《建议供股》《配售事项》 | ⏳ 进行中 |
| 《EGM投票结果》 | 📋 待执行 |
| 《终止公告》 | ❌ 已终止 |

---

## Phase 5: 容错处理

### 无结果时

```
[1] 扩大日期范围至24个月重试
     ↓
[2] 仍无结果 → 检查股票代码有效性
     ↓
[3] 返回标准响应:
    "在过去12/24个月内未发现该股票的{事件类型}事件。
     如需了解其他财技事件，请告知。"
```

### 结果不明确时

- 同时匹配多种事件类型 → 分别列出，请用户确认
- 公告标题不含关键词但内容相关 → 下载PDF详细分析

---

## 完整工作流图

```
START
  │
  ├─[1] 意图识别
  │     └─ 确定事件类型: rights_issue/placement/general_offer/all
  │
  ├─[2] 日期计算
  │     └─ date +%Y%m%d → from_date/to_date
  │
  ├─[3] API搜索
  │     └─ search_hkex_announcements(stock_code, from_date, to_date)
  │
  ├─[4] 关键词筛选
  │     └─ 从标题匹配事件类型关键词
  │
  ├─[5] 下载分析
  │     └─ download_announcement_pdf() → extract_pdf_content()
  │
  ├─[6] 数据提取
  │     └─ 按清单提取A-G类数据
  │
  └─[7] 生成报告
        └─ generate_summary_markdown() → /md/目录
```

